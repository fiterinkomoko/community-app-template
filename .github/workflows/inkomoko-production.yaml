name: Fineract Client Build Production

on:
  push:
    branches: [ inkomoko-prod ]

jobs:
  
  deploy:
    
    name: Deploy archive to ubuntu server
    runs-on: ubuntu-latest

    steps:
    - name: Check out code
      uses: actions/checkout@v2
    
    - name: Setup Node.js and Ruby
      uses: actions/setup-node@v3
      with:
        node-version: '16.13.1'
      
    
    - uses: actions/checkout@v3
    - uses: ruby/setup-ruby@ec02537da5712d66d4d50a0f33b7eb52773b5ed1
      with:
        ruby-version: '2.7'

    - name: Install Bower dependencies
      run: |
        npm install -g bower
        bower --allow-root install
    
    - name: Build and archive app package
      run: |
        npm install --legacy-peer-deps
        npm install -g grunt-cli
        bundle install
        grunt prod
        tar -czvf app.tar.gz dist/community-app
        
    - name: Update known hosts
      run: |
        mkdir -p ~/.ssh
        touch ~/.ssh/known_hosts
        ssh-keyscan -p ${{ secrets.PROD_SERVER_PORT }} -t rsa ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

    - name: Copy file using SCP
      run: |
        HOST=${{ secrets.PROD_SERVER_HOST }}
        USER=${{ secrets.PROD_SERVER_USERNAME }}
        SOURCE_FILE=app.tar.gz
        DESTINATION_DIR=/home/fiter/inkomoko_deployments/frontend
        echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > key.pem
        chmod 400 key.pem
        scp -i key.pem -P ${{ secrets.PROD_SERVER_PORT }} -o StrictHostKeyChecking=no $SOURCE_FILE $USER@$HOST:$DESTINATION_DIR
